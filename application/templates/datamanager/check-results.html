{% extends 'layouts/base.html' %} {% from "components/table.html" import table
%} {% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <!-- Blocking errors -->
    {% if show_error %}
    <div class="govuk-error-summary govuk-!-margin-bottom-6" role="alert">
      <h2 class="govuk-error-summary__title">Data cannot be added</h2>
      <div class="govuk-error-summary__body">
        <p>
          <strong>Please fix the blocking issues before adding data</strong>
        </p>
      </div>
    </div>
    {% endif %}

    <!-- Headings -->
    <span class="govuk-caption-xl">{{ result.params.organisation }}</span>
    <h1 class="govuk-heading-xl">{{ result.params.dataset | title }}</h1>
    <h2 class="govuk-heading-m govuk-!-margin-top-3">Data has been checked</h2>

    <!-- Entity summary (uses server-built message + flag) -->
    <!--<div class="govuk-inset-text">
      {{ new_entities_message }}
      {% if show_entities_link %}
      <div class="govuk-!-margin-top-2">
        <a class="govuk-button" href="{{ entities_preview_url }}">View new entities</a>
      </div>
      {% endif %}
    </div> -->

    <!-- Tabs -->
    <div class="govuk-tabs" data-module="govuk-tabs">
      <ul class="govuk-tabs__list">
        <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
          <a class="govuk-tabs__tab" href="#map">Map</a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#dataset-table">Dataset table</a>
        </li>
      </ul>

      <!-- Map Tab -->
      <div class="govuk-tabs__panel" id="map">
        <div
          id="map-container"
          style="height: 450px; border: 1px solid #ccc"
          data-geometries="{{ geometries | tojson | safe }}"
        ></div>
      </div>

      <!-- Dataset table -->
      <div
        class="govuk-tabs__panel govuk-tabs__panel--hidden"
        id="dataset-table"
      >
        {% if table_params.rows %}
        <div class="dl-table-scrollable-container">
          {{ table(table_params) }}
        </div>

        <p class="govuk-body govuk-!-margin-top-4">
          Showing rows {{ showing_start }} to {{ showing_end }} of {{ total_rows
          }}
        </p>

        <div class="govuk-pagination">
          {% if page > 1 %}
          <a class="govuk-link" href="?page={{ page-1 }}">Previous</a>
          {% endif %} {% if showing_end < total_rows %}
          <a class="govuk-link govuk-!-margin-left-4" href="?page={{ page+1 }}">
            Next</a
          >
          {% endif %}
        </div>
        {% else %}
        <p class="govuk-body">No rows to display</p>
        {% endif %}
      </div>
    </div>

    <!-- Metadata & Results -->
    <div class="govuk-grid-row govuk-!-margin-top-6">
      <div class="govuk-grid-column-one-third">
        <h3 class="govuk-heading-s">Dataset actions</h3>
        <p><a class="govuk-link" href="#">Share these results</a></p>
      </div>

      <div class="govuk-grid-column-two-thirds">
        <dl class="govuk-summary-list">
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">File name</dt>
            <dd class="govuk-summary-list__value">
              {{ result.params.url.split('/')[-1] }}
            </dd>
          </div>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Date checked</dt>
            <dd class="govuk-summary-list__value">
              {{ result.modified or result.created }}
            </dd>
          </div>
        </dl>

        <!-- Passed Checks -->
        {% if passed_checks %}
        <h2 class="govuk-heading-m govuk-!-margin-top-6">
          Data that passed the checks
        </h2>
        <div class="govuk-!-margin-bottom-4">
          {% for check in passed_checks %}
          <div
            class="govuk-!-margin-bottom-2"
            style="display: flex; justify-content: space-between"
          >
            <span>{{ check }}</span>
            <strong class="govuk-tag govuk-tag--green">Passed</strong>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Must fix (blocking issues) -->
        {% if must_fix %}
        <h2 class="govuk-heading-m govuk-!-margin-top-4">
          Issues that must be fixed before adding data
        </h2>
        <div class="govuk-!-margin-bottom-4 govuk-body">
          {% for issue in must_fix %}
          <div
            style="
              display: flex;
              justify-content: space-between;
              border-top: 1px solid #b1b4b6;
              padding: 10px 0;
            "
          >
            <span><a class="govuk-link" href="#">{{ issue }}</a></span>
            <strong class="govuk-tag govuk-tag--red">Must fix</strong>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Fixable issues -->
        {% if fixable %}
        <h2 class="govuk-heading-m">
          Issues that can be fixed after adding data
        </h2>
        <p class="govuk-body">
          Data can be added with these issues, but they should be fixed over
          time.
        </p>
        <div class="govuk-!-margin-bottom-4 govuk-body">
          {% for issue in fixable %}
          <div
            style="
              display: flex;
              justify-content: space-between;
              border-top: 1px solid #b1b4b6;
              padding: 10px 0;
            "
          >
            <span><a class="govuk-link" href="#">{{ issue }}</a></span>
            <strong class="govuk-tag govuk-tag--yellow">Needs fixing</strong>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Buttons -->
        <div
          class="govuk-button-group govuk-!-margin-top-6"
          style="display: flex; justify-content: flex-end; gap: 10px"
        >
          {% if allow_add_data %}
          <form
            method="get"
            action="{{ url_for('datamanager.add_data', request_id=result.id) }}"
          >
            <button type="submit" class="govuk-button">Add data</button>
          </form>
          <form>
            <a
              href="{{ url_for('datamanager.index') }}"
              class="govuk-button govuk-button--secondary"
              >Configure data</a
            >
          </form>
          {% else %}
          <button
            class="govuk-button govuk-button--secondary"
            disabled
            aria-disabled="true"
          >
            Add data
          </button>
          <a href="{{ url_for('datamanager.index') }}" class="govuk-button"
            >Configure data</a
          >
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block pageScripts %} {{ super() }}
<script>
  console.log('Inline script working');
  window.serverContext = {
    containerId: "map-container",
    geometries: {{ geometries | tojson | safe }},
    boundaryGeoJsonUrl: {{ boundary_geojson_url | tojson | safe if boundary_geojson_url else 'null' }}
  };
  console.log('serverContext set:', window.serverContext);
</script>
<script>
  console.log("About to load external script");
</script>
<script src="{{ url_for('datamanager.map_js') }}"></script>
<script>
  console.log("After external script tag");
</script>
{% endblock %}
