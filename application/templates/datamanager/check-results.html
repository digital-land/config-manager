{% extends 'layouts/base.html' %}
{% from "datamanager/components/data-tables.html" import dataTables %}
{% from "datamanager/components/column-mapping.html" import columnMapping %}
{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <!-- Blocking errors -->
    {% if not allow_add_data %}
    <div class="govuk-error-summary govuk-!-margin-bottom-6" role="alert">
      <h2 class="govuk-error-summary__title">Data cannot be added</h2>
      <div class="govuk-error-summary__body">
        <p>
          <strong>Please address the columns not found before adding data</strong>
        </p>
      </div>
    </div>
    {% endif %}

    <!-- Headings -->
    <span class="govuk-caption-xl">{{ result.params.organisation_display }}</span>
    <h1 class="govuk-heading-xl">{{ result.params.dataset_display }}</h1>
    <h2 class="govuk-heading-m govuk-!-margin-top-3">Data has been checked</h2>

    <div class="govuk-inset-text">
      <p>All transformation and issues shown here are with entity lookup disabled.</p>
      <p>Columns shown in <span style="color: red;">Red</span> in the Converted table are not being matched to any fields in the current configuration, and as such are not being transformed.</p>
    </div>

    <!-- Map -->
    {% if geometries %}
    <div class="app-map-container govuk-!-margin-bottom-6" id="map-container" data-geometries="{{ geometries | tojson | safe }}"></div>
    {% endif %}

    <!-- Converted / Transformed data tables -->
    {{ dataTables(converted_table, transformed_table, issue_log_table) }}

    <!-- Metadata & Results -->
    <div class="govuk-grid-row govuk-!-margin-top-6">
      <div class="govuk-grid-column-full">
        <dl class="govuk-summary-list">
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">File name</dt>
            <dd class="govuk-summary-list__value">{{ result.params.url }}</dd>
          </div>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Date checked</dt>
            <dd class="govuk-summary-list__value">
              {{ result.date_checked }}
            </dd>
          </div>
        </dl>

        <!-- Passed Checks -->
        {% if passed_checks %}

        <h2 class="govuk-heading-m govuk-!-margin-top-6">
          Columns found
        </h2>
        <div class="govuk-width-container">
          <ul class="govuk-task-list">
            {% for check in passed_checks %}
            <li class="govuk-task-list__item govuk-task-list__item--with-link">
              <div class="govuk-task-list__name-and-hint">{{ check }}</div>
              <div class="govuk-task-list__status" id="before-you-start-1-status">
                <strong class="govuk-tag govuk-tag--green"> Passed </strong>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- Must fix (blocking issues) -->
        {% if must_fix %}
        <h2 class="govuk-heading-m govuk-!-margin-top-4">
          Columns not found
        </h2>
        <div class="govuk-width-container">
          <ul class="govuk-task-list">
            {% for issue in must_fix %}
            <li class="govuk-task-list__item govuk-task-list__item--with-link">
              <div class="govuk-task-list__name-and-hint">{{ issue }}</div>
              <div class="govuk-task-list__status">
                <strong class="govuk-tag govuk-tag--red">Not found</strong>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- Fixable issues -->
        {% if fixable %}
        <h2 class="govuk-heading-m govuk-!-margin-top-4">
          Error summary
        </h2>
        <div class="govuk-width-container">
          <ul class="govuk-task-list">
            {% for issue in fixable %}
            <li class="govuk-task-list__item govuk-task-list__item--with-link">
              <div class="govuk-task-list__name-and-hint">{{ issue }}</div>
              <div class="govuk-task-list__status">
                <strong class="govuk-tag govuk-tag--yellow">Needs fixing</strong>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- Column Mapping -->
        {% if mapping_rows %}
        {{ columnMapping(mapping_rows, request_id, spec_fields) }}
        {% endif %}

        <!-- Buttons -->
        <div class="govuk-button-group govuk-!-margin-top-6 right-side-buttons">
          {% if allow_add_data %}
          <form method="get" action="{{ url_for('datamanager.add_data', request_id=result.id) }}">
            <button type="submit" class="govuk-button">Check Entities</button>
          </form>
          {% else %}
          <button class="govuk-button govuk-button--secondary" disabled aria-disabled="true">
            Check Entities
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block pageStyles %} {% endblock %} {% block pageScripts %} {{
super() }} {% if geometries %}
<script>
  window.serverContext = {
    containerId: "map-container",
    geometries: {{ geometries | tojson | safe }},
    boundaryGeoJsonUrl: {% if boundary_geojson_url %}{{ boundary_geojson_url | tojson | safe }}{% else %}null{% endif %}
  };
</script>
<script src="{{ url_for('static', filename='javascripts/map.js') }}"></script>
{% endif %}
{% endblock %}