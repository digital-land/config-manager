{% extends 'layouts/base.html' %} {% from "components/table.html" import table
%} {% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <!-- Blocking errors -->
    {% if show_error %}
    <div class="govuk-error-summary govuk-!-margin-bottom-6" role="alert">
      <h2 class="govuk-error-summary__title">Data cannot be added</h2>
      <div class="govuk-error-summary__body">
        <p>
          <strong>Please fix the blocking issues before adding data</strong>
        </p>
      </div>
    </div>
    {% endif %}

    <!-- Headings -->
    <span class="govuk-caption-xl">{{ result.params.organisation }}</span>
    <h1 class="govuk-heading-xl">{{ result.params.dataset | title }}</h1>
    <h2 class="govuk-heading-m govuk-!-margin-top-3">Data has been checked</h2>

    <!-- Tabs -->

    <div class="govuk-tabs" data-module="govuk-tabs">
      {% if geometries %}
      <ul class="govuk-tabs__list">
        <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
          <a class="govuk-tabs__tab" href="#map">Map</a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#dataset-table">Dataset table</a>
        </li>
      </ul>
      {% else %}
      <ul class="govuk-tabs__list">
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#dataset-table">Dataset table</a>
        </li>
      </ul>
      {% endif %}

      <!-- Map Tab -->
      {% if geometries %}
      <div class="govuk-tabs__panel" id="map">
        <div class="app-map-container" id="map-container" data-geometries="{{ geometries | tojson | safe }}"></div>
      </div>
      {% endif %}

      <!-- Dataset table -->
      <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="dataset-table">
        {% if table_params.rows %}
        <div class="app-scrollable-container app-scrollable">
          {{ table(table_params) }}
        </div>
        {% else %}
        <p class="govuk-body">No rows to display</p>
        {% endif %}
      </div>
    </div>

    <!-- Metadata & Results -->
    <div class="govuk-grid-row govuk-!-margin-top-6">
      <div class="govuk-grid-column-full">
        <dl class="govuk-summary-list">
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">File name</dt>
            <dd class="govuk-summary-list__value">{{ result.params.url }}</dd>
          </div>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Date checked</dt>
            <dd class="govuk-summary-list__value">
              {{ result.modified or result.created }}
            </dd>
          </div>
        </dl>

        <!-- Passed Checks -->
        {% if passed_checks %}

        <h2 class="govuk-heading-m govuk-!-margin-top-6">
          Data that passed the checks
        </h2>
        <div class="govuk-width-container">
          <ul class="govuk-task-list">
            {% for check in passed_checks %}
            <li class="govuk-task-list__item govuk-task-list__item--with-link">
              <div class="govuk-task-list__name-and-hint">{{ check }}</div>
              <div class="govuk-task-list__status" id="before-you-start-1-status">
                <strong class="govuk-tag govuk-tag--green"> Passed </strong>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- Must fix (blocking issues) -->
        {% if must_fix %}
        <h2 class="govuk-heading-m govuk-!-margin-top-4">
          Issues that must be fixed before adding data
        </h2>
        <div class="govuk-!-margin-bottom-4 govuk-body">
          {% for issue in must_fix %}
          <div class="app-card-details">
            <span><a class="govuk-link" href="#">{{ issue }}</a></span>
            <strong class="govuk-tag govuk-tag--red">Must fix</strong>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Fixable issues -->
        {% if fixable %}
        <h2 class="govuk-heading-m">
          Issues that can be fixed after adding data
        </h2>
        <p class="govuk-body">
          Data can be added with these issues, but they should be fixed over
          time.
        </p>
        <div class="govuk-!-margin-bottom-4 govuk-body">
          {% for issue in fixable %}
          <div class="app-card-details">
            <span><a class="govuk-link" href="#">{{ issue }}</a></span>
            <strong class="govuk-tag govuk-tag--yellow">Needs fixing</strong>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Buttons -->
        <div class="govuk-button-group govuk-!-margin-top-6 right-side-buttons">
          {% if allow_add_data %}
          <form method="get" action="{{ url_for('datamanager.add_data', request_id=result.id) }}">
            <button type="submit" class="govuk-button">Add data</button>
          </form>
          {% else %}
          <button class="govuk-button govuk-button--secondary" disabled aria-disabled="true">
            Add data
          </button>
          {% if must_fix|length > 0 %}
          <a href="{{ url_for('datamanager.configure_column_mapping', request_id=request_id) }}"
            class="govuk-button">Column mapping</a>
          {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block pageStyles %} {% endblock %} {% block pageScripts %} {{
super() }} {% if geometries %}
<script>
  console.log('Inline script working');
  window.serverContext = {
    containerId: "map-container",
    geometries: {{ geometries | tojson | safe }},
    boundaryGeoJsonUrl: {% if boundary_geojson_url %}{{ boundary_geojson_url | tojson | safe }}{% else %}null{% endif %}
  };
  console.log('serverContext set:', window.serverContext);
</script>
<script>
  console.log("About to load external script");
</script>
<script src="{{ url_for('static', filename='javascripts/map.js') }}"></script>
<script>
  console.log("After external script tag");
</script>
{% endif %}
{% endblock %}