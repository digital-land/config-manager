{% extends 'layouts/base.html' %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    <!-- Error Summary if blocking issues -->
    {% if show_error %}
    <div class="govuk-error-summary govuk-!-margin-bottom-6" role="alert">
      <h2 class="govuk-error-summary__title">Data can not be added</h2>
      <div class="govuk-error-summary__body">
        <p><strong>Data does not include a field we require</strong></p>
      </div>
    </div>
    {% endif %}

    <!-- Headings -->
    <span class="govuk-caption-xl">{{ result.params.organisation }}</span>
    <h1 class="govuk-heading-xl">Article 4 direction</h1>
    <h2 class="govuk-heading-m govuk-!-margin-top-3">Your data has been checked</h2>

    <!-- Tabs -->
    <div class="govuk-tabs" data-module="govuk-tabs">
      <ul class="govuk-tabs__list">
        <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
          <a class="govuk-tabs__tab" href="#map">Map</a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#dataset-table">Dataset table</a>
        </li>
      </ul>

      <div class="govuk-tabs__panel" id="map">
        <div id="map-container" style="height: 450px; border: 1px solid #ccc;"></div>
      </div>

      <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="dataset-table">
        <p class="govuk-body">[Dataset table placeholder]</p>
      </div>
    </div>

    <!-- Metadata and results -->
    <div class="govuk-grid-row govuk-!-margin-top-6">
      <div class="govuk-grid-column-one-third">
        <h3 class="govuk-heading-s">Dataset actions</h3>
        <p><a class="govuk-link" href="#">Share these results</a></p>
      </div>

      <div class="govuk-grid-column-two-thirds">
        <dl class="govuk-summary-list">
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">File name</dt>
            <dd class="govuk-summary-list__value">{{ result.params.dataset }}.csv</dd>
          </div>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key">Date checked</dt>
            <dd class="govuk-summary-list__value">{{ result.created }}</dd>
          </div>
        </dl>

        <h2 class="govuk-heading-m govuk-!-margin-top-6">Data that passed the checks</h2>
        <div class="govuk-!-margin-bottom-4">
          <div class="govuk-!-margin-bottom-2" style="display: flex; justify-content: space-between;">
            <span>Found 50 rows</span>
            <strong class="govuk-tag govuk-tag--green">Passed</strong>
          </div>
          <div class="govuk-!-margin-bottom-2" style="display: flex; justify-content: space-between;">
            <span>All rows have unique references</span>
            <strong class="govuk-tag govuk-tag--green">Passed</strong>
          </div>
          <div class="govuk-!-margin-bottom-2" style="display: flex; justify-content: space-between;">
            <span>All rows have valid geometry</span>
            <strong class="govuk-tag govuk-tag--green">Passed</strong>
          </div>
        </div>

        <!-- Must fix errors -->
        {% if must_fix %}
        <h2 class="govuk-heading-m govuk-!-margin-top-4">Issues you must fix before submitting</h2>
        <div class="govuk-!-margin-bottom-4 govuk-body">
          {% for issue in must_fix %}
          <div style="display: flex; justify-content: space-between; border-top: 1px solid #b1b4b6; padding: 10px 0;">
            <span><a class="govuk-link" href="#">{{ issue | safe }}</a></span>
            <strong class="govuk-tag govuk-tag--red">Must fix</strong>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Fixable issues -->
        {% if fixable %}
        <h2 class="govuk-heading-m">Issues you can fix after submitting</h2>
        <p class="govuk-body">
          You can submit your data with these issues but should fix them over time to improve the quality and usability of the data.
        </p>
        <div class="govuk-!-margin-bottom-4 govuk-body">
          {% for issue in fixable %}
          <div style="display: flex; justify-content: space-between; border-top: 1px solid #b1b4b6; padding: 10px 0;">
            <span><a class="govuk-link" href="#">{{ issue | safe }}</a></span>
            <strong class="govuk-tag govuk-tag--yellow">Needs fixing</strong>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="govuk-button-group govuk-!-margin-top-6" style="display: flex; justify-content: flex-end;">
          {% if allow_add_data %}
          <a href="#" class="govuk-button">Add data</a>
          {% else %}
          <a href="#" class="govuk-button">Upload new version</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block pageScripts %}
<link rel="stylesheet" href="https://unpkg.com/govuk-frontend/govuk/all.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/govuk-frontend/govuk/all.js"></script>

<script>
  window.GOVUKFrontend.initAll();
  document.addEventListener("DOMContentLoaded", function() {
    const map = L.map('map-container').setView([50.3755, -4.1427], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const polygon = {
      "type": "Feature",
      "geometry": {
        "type": "Polygon",
        "coordinates": [
          [
            [-4.2, 50.4],
            [-4.1, 50.4],
            [-4.1, 50.3],
            [-4.2, 50.3],
            [-4.2, 50.4]
          ]
        ]
      },
      "properties": {
        "name": "Sample Area"
      }
    };
    L.geoJSON(polygon, {
      style: {
        color: 'red',
        weight: 2,
        fillOpacity: 0.4
      }
    }).addTo(map);
  });
</script>
{% endblock %}