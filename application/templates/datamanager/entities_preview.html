{% extends 'layouts/base.html' %}
{% from "components/table.html" import table %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-l">Preview and Confirm</h1>
    <p class="govuk-body">
      Review the summary of new and existing entities before confirming.
    </p>

    <h2 class="govuk-heading-m">Summary</h2>
    <dl class="govuk-summary-list govuk-!-margin-bottom-9">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
          Rows that match existing entities
        </dt>
        <dd class="govuk-summary-list__value">{{ existing_count }}</dd>
      </div>
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
          Rows that will create new entities
        </dt>
        <dd class="govuk-summary-list__value">{{ new_count }}</dd>
      </div>
    </dl>

    {% if new_count > 0 %}
    <section class="govuk-!-margin-bottom-9">
      <h2 class="govuk-heading-m">New entities ({{ new_count }})</h2>
      {% if table_params and table_params.rows %}
      <div class="dl-table-scrollable-container">{{ table(table_params) }}</div>
      {% endif %}
      <details
        class="govuk-details govuk-!-margin-bottom-4"
        data-module="govuk-details"
      >
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text"
            >Copy CSV for <code>lookup.csv</code></span
          >
        </summary>
        <div class="govuk-details__text">
          {% set _ep_lines = (lookup_csv_text or '').splitlines() %}
          <textarea class="govuk-textarea" rows="6" readonly>
{{ _ep_lines[0:] | join('\n') }}</textarea
          >
          <p class="govuk-hint govuk-!-margin-top-2">
            Copy this line into your local <code>lookup.csv</code>.
          </p>
        </div>
      </details>
    </section>
    {% endif %}

    <section class="govuk-!-margin-bottom-9">
      <h2 class="govuk-heading-m">Existing entities ({{ existing_count }})</h2>
      {% if existing_table_params and existing_table_params.rows %}
      <div class="dl-table-scrollable-container">
        {{ table(existing_table_params) }}
      </div>
      {% else %}
      <p class="govuk-body">
        No existing entities were detected in this resource.
      </p>
      {% endif %}
    </section>

    <section class="govuk-!-margin-bottom-9">
      <h2 class="govuk-heading-m">Endpoint Summary</h2>
      <dl class="govuk-summary-list">
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Endpoint URL</dt>
          <dd class="govuk-summary-list__value" style="word-break: break-all">
            {{ endpoint_url }}
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Endpoint already in system</dt>
          <dd class="govuk-summary-list__value">
            {{ endpoint_already_exists }}
          </dd>
        </div>
      </dl>
    </section>

    {% if source_summary %}
    <section class="govuk-!-margin-bottom-9">
      <h2 class="govuk-heading-m">Source Summary</h2>
      <dl class="govuk-summary-list">
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Will create new source row</dt>
          <dd class="govuk-summary-list__value">
            {{source_summary.will_create}}
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">source</dt>
          <dd class="govuk-summary-list__value">
            <code>{{ source_summary.source }}</code>
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">collection</dt>
          <dd class="govuk-summary-list__value">
            {{ source_summary.collection }}
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">organisation</dt>
          <dd class="govuk-summary-list__value">
            {{ source_summary.organisation }}
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">endpoint</dt>
          <dd class="govuk-summary-list__value">
            <code>{{ source_summary.endpoint }}</code>
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">licence</dt>
          <dd class="govuk-summary-list__value">
            {{ source_summary.licence }}
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">pipelines</dt>
          <dd class="govuk-summary-list__value">
            {{ source_summary.pipelines }}
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">documentation-url</dt>
          <dd class="govuk-summary-list__value" style="word-break: break-all">
            {{ source_summary.documentation_url }}
          </dd>
        </div>
        {% if source_summary.attribution %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">attribution</dt>
          <dd class="govuk-summary-list__value">
            {{ source_summary.attribution }}
          </dd>
        </div>
        {% endif %}
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">entry-date</dt>
          <dd class="govuk-summary-list__value">
            {{ source_summary.entry_date }}
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">start-date</dt>
          <dd class="govuk-summary-list__value">
            {{ source_summary.start_date }}
          </dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">end-date</dt>
          <dd class="govuk-summary-list__value">
            {{ source_summary.end_date }}
          </dd>
        </div>
      </dl>
    </section>
    {% endif %}

    {% if endpoint_csv_table_params %}
    <section class="govuk-!-margin-bottom-9">
      <h2 class="govuk-heading-m">endpoint.csv (canonical row)</h2>
      <div class="dl-table-scrollable-container govuk-!-margin-bottom-2">
        {{ table(endpoint_csv_table_params) }}
      </div>
      {% if endpoint_csv_text != '' %}
      <details
        class="govuk-details govuk-!-margin-bottom-4"
        data-module="govuk-details"
      >
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text"
            >Copy CSV for <code>endpoint.csv</code></span
          >
        </summary>
        <div class="govuk-details__text">
          {% set _ep_lines = (endpoint_csv_text or '').splitlines() %}
          <textarea class="govuk-textarea" rows="2" readonly>
{{ _ep_lines[0:] | join('\n') }}</textarea
          >
          <p class="govuk-hint govuk-!-margin-top-2">
            Copy this line into your local <code>endpoint.csv</code>.
          </p>
        </div>
      </details>
      {% endif %}
    </section>
    {% endif %}

    {% if source_csv_table_params %}
    <section class="govuk-!-margin-bottom-9">
      <h2 class="govuk-heading-m">source.csv (canonical row)</h2>
      <div class="dl-table-scrollable-container govuk-!-margin-bottom-2">
        {{ table(source_csv_table_params) }}
      </div>
      {% if source_csv_text != '' %}
      <details
        class="govuk-details govuk-!-margin-bottom-4"
        data-module="govuk-details"
      >
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text"
            >Copy CSV for <code>source.csv</code></span
          >
        </summary>
        <div class="govuk-details__text">
          {# show CSV body only (drop header) #}
          {% set _src_lines = (source_csv_text or '').splitlines() %}
          <textarea class="govuk-textarea" rows="2" readonly>{{ _src_lines[1:] | join('\n') }}</textarea>
          <p class="govuk-hint govuk-!-margin-top-2">Copy this line into your local <code>source.csv</code>.</p>
        </div>
      </details>
      {% endif %}
    </section>
    {% endif %}

    <div class="govuk-button-group">
      <form method="get" action="{{ url_for('datamanager.index') }}">
        <button
          type="submit"
          class="govuk-button"
          disabled
          aria-disabled="true"
        >
          Confirm and add data
        </button>
      </form>

      <form>
        <a
          href="{{ url_for('datamanager.index') }}"
          class="govuk-button govuk-button--secondary"
          >Go Back</a
        >
      </form>
    </div>
  </div>
</div>
{% endblock %}
