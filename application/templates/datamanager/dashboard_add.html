{% extends 'layouts/base.html' %}

{% from "govuk_frontend_jinja/components/breadcrumbs/macro.html" import govukBreadcrumbs %}
{% from "govuk_frontend_jinja/components/button/macro.html" import govukButton %}
{% from "govuk_frontend_jinja/components/input/macro.html" import govukInput %}
{% from "govuk_frontend_jinja/components/select/macro.html" import govukSelect %}

{% block pageStylesheets %}
<link rel="stylesheet" href="https://unpkg.com/accessible-autocomplete@2.0.4/dist/accessible-autocomplete.min.css">
{% endblock pageStylesheets %}

{% block beforeContent %}
{{ govukBreadcrumbs({
'items': [
{ 'text': "Home", 'href': url_for('base.index') },
{ 'text': "DataManager", 'href': url_for('datamanager.index') },
{ 'text': "CheckData", 'href': url_for('datamanager.dashboard_add') },
{ 'text': "Check Planning data" }
]
}) }}
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-xl">Check Planning data</h1>
  </div>
</div>

<div class="govuk-grid-row govuk-!-margin-top-6">
  <div class="govuk-grid-column-one-half">
    <h2 class="govuk-heading-l">Check planning data</h2>

    <form method="post" action="{{ url_for('datamanager.dashboard_add') }}" novalidate>
      <input type="hidden" id="mode" name="mode" value="">

      {% set organisation_error = errors.get('organisation') %}
      {% set documentation_error = errors.get('documentation_url') %}
      {% set dataset_error = errors.get('dataset') %}
      {% set environment_error = errors.get('endpoint_url') %}

      {% if organisation_error or documentation_error or dataset_error or environment_error or errors.start_date %}
      <div class="govuk-error-summary" role="alert" tabindex="-1" data-module="govuk-error-summary">
        <h2 class="govuk-error-summary__title" id="error-summary-title">There is a problem</h2>
        <div class="govuk-error-summary__body">
          <ul class="govuk-list govuk-error-summary__list">
            {% if dataset_error %}<li><a href="#dataset">Select a dataset</a></li>{% endif %}
            {% if organisation_error %}<li><a href="#organisation">Enter your organisation</a></li>{% endif %}
            {% if environment_error %}<li><a href="#endpoint-url">Enter a valid endpoint URL</a></li>{% endif %}
            {% if documentation_error %}<li><a href="#documentation-url">Enter a valid documentation URL</a></li>{%
            endif %}
            {% if errors.start_date %}<li><a href="#start-day">Enter a valid date (numeric day/month/year)</a></li>{%
            endif %}
          </ul>
        </div>
      </div>
      {% endif %}

      <!-- Dataset autocomplete -->
      <div class="govuk-form-group {% if dataset_error %}govuk-form-group--error{% endif %}">
        <label class="govuk-label" for="dataset-autocomplete">Dataset name</label>
        {% if dataset_error %}
        <p class="govuk-error-message">
          <span class="govuk-visually-hidden">Error:</span> Select a dataset
        </p>
        {% endif %}
        <div id="autocomplete-container" class="govuk-!-margin-bottom-4"></div>
        <input type="hidden" name="dataset" id="dataset" value="{{ form.dataset or dataset_input }}">
      </div>

      <!-- Organisation autocomplete -->
      <div class="govuk-form-group {% if organisation_error %}govuk-form-group--error{% endif %}">
        <label class="govuk-label" for="organisation">Organisation</label>
        {% if organisation_error %}
        <p class="govuk-error-message">
          <span class="govuk-visually-hidden">Error:</span> Enter your organisation
        </p>
        {% endif %}
        <div id="org-autocomplete-container" class="govuk-!-margin-bottom-4">
          <div id="org-autocomplete-wrapper"></div>
        </div>
        <input type="hidden" name="organisation" id="organisation" value="{{ form.organisation or '' }}">
      </div>

      <!-- Endpoint URL -->
      <div class="govuk-form-group {% if environment_error %}govuk-form-group--error{% endif %}">
        {{ govukInput({
        'label': { 'html': 'Endpoint URL <span class="govuk-required">*</span>' },
        'id': 'endpoint-url',
        'name': 'endpoint_url',
        'value': form.get('endpoint_url', ''),
        'attributes': { 'required': 'required', 'type': 'url' }
        }) }}
      </div>

      <!-- Documentation URL -->
      <div class="govuk-form-group {% if documentation_error %}govuk-form-group--error{% endif %}">
        {{ govukInput({
        'label': { 'text': 'Documentation URL (optional)' },
        'id': 'documentation-url',
        'name': 'documentation_url',
        'value': form.get('documentation_url', ''),
        'attributes': {
        'pattern': '(^$)|https?://.*\\.(gov\\.uk|org\\.uk)(/.*)?',
        'title': 'Must be a valid URL ending in .gov.uk or .org.uk if provided'
        },
        'errorMessage': ( { 'text': 'Enter a valid documentation URL ending in .gov.uk or .org.uk' } if
        documentation_error else None )
        }) }}
      </div>

      <!-- Start date -->
      <fieldset class="govuk-fieldset" role="group" aria-describedby="start-date-error">
        <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">Start date (defaults to today)</legend>

        {% if errors.start_date %}
        <p id="start-date-error" class="govuk-error-message">
          <span class="govuk-visually-hidden">Error:</span> Enter a real start date (day/month/year)
        </p>
        {% endif %}

        {% set today = now.now() %}
        <div class="govuk-date-input" id="start-date">
          <div class="govuk-date-input__item">
            <label class="govuk-label govuk-date-input__label" for="start-day">Day</label>
            <input class="govuk-input govuk-input--width-2" id="start-day" name="start_day" type="text"
              inputmode="numeric" value="{{ form.start_day or today.day }}">
          </div>
          <div class="govuk-date-input__item">
            <label class="govuk-label govuk-date-input__label" for="start-month">Month</label>
            <input class="govuk-input govuk-input--width-2" id="start-month" name="start_month" type="text"
              inputmode="numeric" value="{{ form.start_month or today.month }}">
          </div>
          <div class="govuk-date-input__item">
            <label class="govuk-label govuk-date-input__label" for="start-year">Year</label>
            <input class="govuk-input govuk-input--width-4" id="start-year" name="start_year" type="text"
              inputmode="numeric" value="{{ form.start_year or today.year }}">
          </div>
        </div>
      </fieldset>

      <!-- Licence -->
      {{ govukSelect({
      'id': 'licence',
      'name': 'licence',
      'label': { 'text': 'Data is provided under which licence?' },
      'items': [
      { 'value': '', 'text': 'e.g OGL' },
      { 'value': 'ogl', 'text': 'OGL' },
      { 'value': 'cc-by', 'text': 'CC-BY' }
      ],
      'value': form.get('licence', '')
      }) }}

      <div style="display: flex; justify-content: flex-end">
        {{ govukButton({
        'text': 'Check data',
        'attributes': { 'onclick': "document.getElementById('mode').value='final';" }
        }) }}
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block pageScripts %}
<script src="https://unpkg.com/accessible-autocomplete@2.0.4/dist/accessible-autocomplete.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const datasetContainer = document.querySelector('#autocomplete-container');
    const datasetHidden = document.getElementById('dataset');
    const orgWrapper = document.getElementById('org-autocomplete-wrapper');
    const hiddenOrgInput = document.getElementById('organisation');
    const orgList = JSON.parse('{{ selected_orgs | default([]) | tojson | safe }}');

    // Dataset autocomplete
    accessibleAutocomplete({
      element: datasetContainer,
      id: 'dataset-autocomplete',
      name: 'dataset-autocomplete-visible',
      defaultValue: "{{ dataset_input | default('') }}",
      minLength: 2,
      confirmOnBlur: false,
      autoselect: true,
      displayMenu: 'overlay',
      placeholder: 'Type dataset nameâ€¦',
      source: function (query, populateResults) {
        fetch("{{ url_for('datamanager.dashboard_add') }}?autocomplete=" + encodeURIComponent(query))
          .then(response => response.json())
          .then(data => populateResults(data));
      },
      onConfirm: function (val) {
        datasetHidden.value = val;
        hiddenOrgInput.value = '';

        fetch(`{{ url_for('datamanager.dashboard_add') }}?get_orgs_for=${encodeURIComponent(val)}`)
          .then(res => res.json())
          .then(orgs => {
            if (orgs.length === 0) {
              orgWrapper.innerHTML = '<p class="govuk-body">No organisations found</p>';
              return;
            }

            // Replace wrapper contents only, no page flicker
            const newWrapper = document.createElement('div');
            orgWrapper.replaceChildren(newWrapper);

            accessibleAutocomplete({
              element: newWrapper,
              id: 'org-autocomplete',
              name: 'org-autocomplete-visible',
              source: orgs,
              displayMenu: 'overlay',
              autoselect: true,
              defaultValue: '',
              placeholder: 'Type organisation name...',
              onConfirm: function (val) {
                hiddenOrgInput.value = val;
              }
            });
          });
      }
    });

    // Initialise org autocomplete on page load (even if empty)
    const initialWrapper = document.createElement('div');
    orgWrapper.appendChild(initialWrapper);

    accessibleAutocomplete({
      element: initialWrapper,
      id: 'org-autocomplete',
      name: 'org-autocomplete-visible',
      source: orgList,
      displayMenu: 'overlay',
      autoselect: true,
      defaultValue: "{{ form.organisation | escape }}",
      placeholder: orgList.length ? 'Type organisation name...' : 'Select a dataset first...',
      onConfirm: function (val) {
        hiddenOrgInput.value = val;
      }
    });
  });
</script>
{% endblock %}